# 🌱 스마트팜 환경 제어 시스템 (Smart Farm Project)

STM32F411RE 보드와 온습도 센서, 수위 센서, 서보 모터, 스텝 모터, 부저, RGB LED, LCD를 활용해  
**온도·습도·수위에 따라 자동으로 펌프와 선풍기를 제어하는 임베디드 스마트팜 시스템**입니다.  
FreeRTOS 기반 구조로 센서/모터/표시 장치를 태스크 단위로 분리해 구현했습니다.

---

## 📌 프로젝트 개요 및 목표

이 프로젝트는 **환경 센서 기반 자동 제어 스마트팜 시스템**을 구축하는 것을 목표로 합니다.  
온습도/수위 센서 데이터를 주기적으로 읽고, 그에 따라 **물 공급(펌프) / 공기 순환(팬)**을 자동 제어하여  
사용자가 최소한의 개입으로 스마트팜 상태를 관리할 수 있도록 설계했습니다.

---

## 🎯 주요 목표

- **온습도 모니터링**
  - DHT11 센서를 통해 온도·습도를 주기적으로 측정
  - 측정 값을 LCD에 실시간 표시하여 환경 상태를 직관적으로 확인 가능

- **수위 기반 펌프 제어**
  - 물 수위 센서 값을 기준으로 **물 부족/적정/과다 상태 판단**
  - 물 부족일 경우 서보 모터(펌프 역할)를 2/3/4회 동작시켜 단계별 보충

- **온도 기반 선풍기(스텝 모터) 제어**
  - 기본 속도 회전 유지
  - 온도가 기준치(예: 30°C) 이상일 경우 선풍기 회전 속도 증가

- **경고 및 상태 표시**
  - 과수위, 과열 등의 조건 만족 시 부저로 경고
  - RGB LED 색상으로 전체 상태(정상/주의/경고)를 한눈에 표시

- **RTOS 기반 안정적 구조 구현**
  - FreeRTOS를 이용한 태스크 분리 및 우선순위 설정
  - 센서 측정, 제어 로직, 표시(UI)를 독립 태스크로 운영하여 시스템 안정성 확보

---

## 🧩 사용 부품 및 하드웨어 구성

| 부품                         | 역할                            | 연결 핀(STM32 예시)      |
|----------------------------|---------------------------------|--------------------------|
| STM32 Nucleo-F411RE        | 메인 MCU, 전체 시스템 제어       | -                        |
| DHT11 온습도 센서          | 온도 및 습도 측정                | (예) PA0                 |
| 수위 센서 (Water Level)    | 물 높이 감지 (아날로그 입력)     | (예) PA1(ADC)           |
| 서보 모터                  | 물 펌프 역할 (각도 제어)         | (예) PA8 (TIM1_CH1 PWM) |
| 스텝 모터 + ULN2003 드라이버 | 선풍기 역할 (방향/속도 제어)     | (예) PB0~PB3            |
| 부저 (Buzzer)              | 경고음 출력                      | (예) PB10               |
| RGB LED                    | 시스템 상태 시각적 표시          | (예) PC0(R), PC1(G), PC2(B) |
| I2C LCD (16x2 등)          | 온습도·상태 정보 텍스트 표시     | (예) PB8(SCL), PB9(SDA) |

> 실제 사용 보드/핀맵에 맞춰 핀 번호는 수정해서 사용하세요.

---

## 🔄 시스템 동작 흐름

### 🔎 1) 환경 센서 측정

- DHT11 센서에서 주기적으로 **온도/습도** 읽기
- 수위 센서에서 아날로그 값을 읽어 **물 부족/적정/과다** 구간으로 분류
- 측정 값은 내부 변수 및 LCD 출력에 사용

---

### 💧 2) 물 수위 기반 펌프 제어 (서보 모터)

- 수위 센서 값이 **임계값 이하(물 부족)** 일 때:
  - 서보 모터를 물 펌프로 가정하여 작동
  - 부족 정도에 따라 펌프 회전 횟수 조절  
    - 1단계 부족: 2회 동작  
    - 2단계 부족: 3회 동작  
    - 3단계 부족: 4회 동작
- 수위가 정상 범위에 도달하면 펌프 동작 중지

---

### 🌬 3) 온도 기반 선풍기 제어 (스텝 모터)

- 기본 상태:
  - 낮은 속도로 **계속 회전(CW 또는 CCW)**  
- 온도가 기준치(예: 30°C)를 초과하면:
  - 스텝 모터 구동 주기 단축 → 회전 속도 증가
- 온도가 다시 기준치 이하로 떨어지면:
  - 기본 속도로 복귀

---

### 🚨 4) 알림 및 상태 표시 (부저 + RGB LED + LCD)

- **과수위 또는 과열 상태** 감지 시:
  - 부저 ON → 사용자에게 경고
- RGB LED 색상 예시:
  - 초록: 정상
  - 노랑: 주의(수위/온도 임계 근접)
  - 빨강: 경고(수위 과다, 온도 과열 등)
- LCD에는 현재 온도/습도/상태 메시지 출력  
  (예: “TEMP: 31°C  FAN: HIGH  PUMP: OFF”)

---

## 🧵 RTOS 기반 Task 구성

| Task 이름         | Priority | 역할                                   |
|------------------|----------|----------------------------------------|
| defaultTask(Core)| Normal   | 시스템 메인 로직, 상태 관리, 이벤트 분배 |
| SensorTask       | Low      | 온습도·수위 센서 주기적 측정            |
| MotorTask        | Low      | 서보 모터(펌프) 및 스텝 모터(팬) 제어   |
| DisplayTask      | Low      | LCD 출력, RGB LED 상태 갱신            |
| AlertTask        | Low      | 부저 경고 제어, 경고 상태 관리         |

> 실제 구현된 태스크 이름/우선순위에 맞게 수정하면 됩니다.

---

## 🧠 소프트웨어 주요 로직

### 🧩 Core Logic

- **메시지 큐 / 플래그 기반 이벤트 처리**
  - 센서 태스크 → 환경 상태(온도, 습도, 수위)를 구조체/플래그로 전달
  - Core/Control 태스크 → 조건에 따라 “펌프 ON/OFF”, “팬 속도 변경”, “경고 발생” 등의 이벤트 생성
- **초기화 과정**
  - GPIO / ADC / PWM / I2C / Timer / FreeRTOS 초기화
  - 센서/모터 초기 위치 세팅
  - LCD 초기 메시지 출력 (예: “Smart Farm Ready”)

- **상태 기반 제어 로직 예시**
  - `if (waterLevel < THRESHOLD_LOW)` → 펌프 동작 이벤트
  - `if (temp >= TEMP_HIGH)` → 팬 속도 HIGH 이벤트
  - `if (waterLevel > THRESHOLD_HIGH)` 또는 `temp > TEMP_CRITICAL` → 경고 이벤트(부저 + LED RED)

---

### 🌡 Sensor Manager Logic

- **SensorTask**
  - 주기적으로 DHT11, 수위 센서 값을 읽어 필터링(노이즈 제거)
  - 온도/습도/수위 값을 구조체로 정리 후 큐에 전달
  - 센서 오류(값 범위 벗어남 등) 감지 시 별도 플래그 설정

---

### ⚙️ Actuator/Motor Manager Logic

- **MotorTask**
  - 큐에서 제어 명령(펌프 ON/OFF, 팬 속도 단계)을 수신
  - 서보 모터:
    - 펌프 역할, 각도 변경으로 펌프 동작 횟수 제어
  - 스텝 모터:
    - 방향/속도(스텝 간 딜레이)로 팬 회전 상태 제어

- **DisplayTask**
  - 최신 센서 값과 제어 상태를 LCD에 주기적으로 출력
  - RGB LED 색상 갱신 (정상/주의/경고 상태)

- **AlertTask**
  - 경고 상태 플래그에 따라 부저 ON/OFF
  - 일정 시간 경과 후 자동 OFF / 사용자 확인에 따라 OFF 등 구현 가능

---

## 📺 시연 결과 (Summary)

- **센서 값 표시**
  - DHT11에서 읽은 온도/습도 값이 LCD에 정상적으로 표시
  - 수위 변화에 따라 상태 메시지 업데이트

- **물 수위 제어**
  - 물 부족 구간 진입 시:
    - 서보 모터(펌프)가 설정된 횟수만큼 동작 → 수위 회복
  - 과수위 상태 진입 시:
    - 부저 경고 및 LED 색상 변경으로 알림

- **온도 기반 팬 제어**
  - 실험적으로 온도를 올렸을 때 스텝 모터 회전 속도가 증가하는 것 확인
  - 온도가 내려가면 기본 속도/정지 상태로 자동 복귀

- **상태 표시 및 경고 동작**
  - RGB LED 색상과 LCD 메시지를 통해 현재 스마트팜 상태를 직관적으로 확인 가능
  - 과열·과수위 상황에서 부저가 정상적으로 울리는 것 확인

---

## 🔮 향후 개선 방향

| 개선 항목                | 내용                                                           | 기대 효과                         |
|-------------------------|----------------------------------------------------------------|-----------------------------------|
| 토양 수분 센서 추가      | 실제 화분/작물에 토양 수분 센서를 부착해 자동 관수와 연동       | 실제 농업 환경과의 밀착도 향상    |
| 통신 모듈 연동 (Wi-Fi/BLE) | 스마트폰 앱/웹 대시보드에서 상태 모니터링 및 원격 제어          | 사용자 편의성 및 확장성 증가      |
| 데이터 로깅/시각화       | 온도·습도·수위·제어 이력 기록 후 PC/클라우드에서 그래프 확인    | 환경 변화 분석 및 튜닝에 도움     |
| AI 기반 제어 정책       | 기록된 데이터를 활용한 머신러닝/룰 기반 최적 제어 정책 연구     | 에너지 절약 및 작물 성장 최적화   |
| 하드웨어 모듈화/보드화   | 센서/모터/MCU 모듈을 PCB로 통합 설계                            | 프로젝트 완성도 및 포트폴리오 강화 |

---

## 🙌 정리

이 프로젝트를 통해

- `ADC / PWM / I2C / Timer / GPIO / FreeRTOS`를 모두 활용하는 **임베디드 통합 시스템**을 경험했고,
- 센서 데이터 처리, 모터 제어, 태스크 설계, 상태 표시/경고까지  
  **스마트팜의 핵심 흐름을 한 번에 구현**해볼 수 있었습니다.

실제 농업 환경에 바로 적용하기보다는,  
**스마트팜 개념을 학습하고 임베디드 실전 감각을 기르기 위한 포트폴리오용 프로젝트**라는 점에 의의가 있습니다.
